# 6. ICMP Internet控制报文协议

- ICMP报文是在IP数据报内部传输的，如图：			
	![](6-1.jpg)
- ICMP报文的格式如图：					
	![](6-2.jpg)

### 6.2 ICMP报文的类型

- 不同类型的ICMP报文由类型字段和代码字段共同决定，分为查询和差错报文
- ICMP差错报文始终包含IP首部和产生ICMP差错报文的IP数据报的前8个字节
- 不会产生ICMP差错报文的情况：
	- ICMP差错报文（ICMP查询报文是可能产生差错报文的）
	- 目的地址是广播或多播地址的IP数据报
	- 链路层广播的数据报
	- 不是IP分片的第一片
	- 源地址不是单个主机的数据报（零地址、环回地址、广播多播地址）

### 6.3 ICMP地址掩码请求与应答

ICMP地址掩码请求用于**无盘系统**在引导过程中获取自己的子网掩码。与RARP类似，系统会广播ICMP地址掩码请求，收到的应答正常情况下是单播的

- ICMP地址掩码请求与应答报文格式如图：				
	![](6-3.jpg)
- 广播ICMP请求的发送主机也会发送一份拷贝到本机的环回接口，这就是广播的定义
- 向本机地址和环回地址发送地址掩码请求时，返回的地址掩码对应的都是环回地址(127.0.0.1)

### 6.4 ICMP时间戳请求与应答

向另一个系统查询当前的时间，时间精度是毫秒级别。报文格式类似地址掩码报文：
	![](6-4.jpg)

- 用途举例：
	- 用于同步主机的时间戳。可以根据请求报文RTT（往返时间）、请求报文发送时间戳和接收时间戳来确定主机间的时间差距
- 还可以通过telnet登录其它主机，运行daytime服务程序获取其它主机的时间

### 6.5 ICMP端口不可达差错

- 用tftp生成一个端口不可达报文：			
	![](6-5.jpg)
	- tcpdump查看报文的交换过程：				
		![](6-6.jpg)
	- ICMP报文是在主机之间交换（体现IP层），UDP报文是在端口之间交换

- 端口不可达报文格式如图：				
	![](6-7.jpg)
	![](6-8.jpg)
	- ICMP端口不可达报文中，UDP首部包含了原UDP报文目的端口和源端口。目的端口用于告知哪个端口不可达，源端口用于源主机由内核确定将此ICMP报文交给哪个用户进程处理（因为ICMP只在IP层，具体到用户进程需要端口信息）
	- 可观察到tftp程序在25秒后才提示传输失败，其间重传了5次UDP数据报，因为内核在收到ICMP后没有通知tftp用户进程

### 6.6 ICMP报文的BSD处理

不同系统对ICMP报文的处理是不同的，反应到的是在用户进程层面上的处理不同

###习题

1. 在可能产生ICMP差错报文的条件下，若在局域网上向不存在的端口发送一份广播的UDP数据报，会发生什么

	局域网上所有的主机都可能在同一时刻响应一个ICMP端口不可达的差错报文。这些报文的传输可能发生冲突，可能会造成网络短暂的阻塞、网络不可用

2. 生成一个ICMP端口不可达差错的级别是“必须”、“应该”还是“可能”
	
	应该

3. 略

4. `netstat -s`用于查看每个协议的统计数据


# 7. Ping程序

为了测试另一台主机是否可达。 该程序发送和接收ICMP回显请求和应答

如果Ping不同某台主机，那就不能Telnet或FTP到此主机；若不能Telnet或FTP到某主机，就可以通过Ping程序确定问题出在哪里

Ping服务器一般在内核中实现ICMP的功能

### 7.2 Ping程序

- ICMP回显请求和应答报文格式：			
	![](7-1.jpg)
- LAN（局域网）输出：				
	![](7-2.jpg)
	![](7-3.jpg)
- WAN（广域网）
	- 在广域网上的Ping程序就有可能发生丢失、重复、失序的情况
- SLIP线路
	- 略
- 拨号SLIP链路
	- 略

### 7.3 IP记录路由选项

- Ping程序的-R选项提供记录路由的功能，会在ICMP回显请求中设置IP路由选项（指的是**IP首部中的选项**）。每个处理该数据报的路由器都会把自己的IP放入选项字段中，达到目的端时，将请求中的IP清单复制到应答中，然后在返回的路径中再添加剩余的IP
	- 此方法的主要缺陷：IP首部最长60个字节，固定长度加上路由选项用去23个字节，只剩37个字节，只能存放9个IP地址，远远不足
	- IP路由记录路由器的出口IP地址

- 举例（svr4主机ping至slip主机）：						
	![](7-4.jpg)
	- 网络结构及数据报流向如图：			
		![](7-5.jpg)
	- `tcpdump -v`可查看带路由选项的输出：
		![](7-6.jpg)
- 异常的输出（slip主机ping至aix主机）：
	![](7-7.jpg)
	![](7-8.jpg)
	- 此例还将引出ICMP重定向的问题

### 7.4 IP时间戳选项

即带有时间戳的IP路由记录，只能记录4对时间戳和IP

### 习题

1. 画以上ping输出的时间线
	
	略

2. 关于SLIP链路报文计算的问题

3. 关于SLIP链路报文计算的问题2

4. 关于压缩SLIP的问题

5. 2.7节中，ping环回地址和本身主机的以太网地址会出现什么不同

	ping环回地址的RTT要比ping本身主机以太网地址的RTT要小（极小差别），因为以太网驱动程序需要时间来判定这个数据报的目的地址是一个本地的主机。 但是他们的数据报都不会经过以太网（见2.7）


# 8. Traceroute程序 

看到IP数据报从一台主机传到另一台主机所经过的路由

为什么不用Ping程序的-R功能：
- 并不是所有的路由器都支持IP路由选项，Traceroute程序对所有的路由器都适用
- 记录路由是单向的选项，发送端设置了之后，接收端不得不返回
- 最主要的，IP首部的空间有限，记录的数目有限

### 8.2 Traceroute程序的操作

- Traceroute程序使用ICMP报文和IP首部中的TTL字段，每个处理数据报的路由器都会将TTL减1
- TTL字段是为了防止数据报在选路时无休止地在网络中流动
- 当路由器收到TTL为0或1的数据报时，路由器（目的主机可以将其交给应用程序）将数据报丢弃，并**返回ICMP超时报文**

所以，Traceroute程序的原理如下：
- 发送一份TTL为1的数据报给目的主机，将被第一个路由器丢弃并返回ICMP报文，ICMP报文包含了路由器的地址信息
- 发送一份TTL为2的数据报给目的主机，获得第二个路由器的信息
- 直至数据报达到目的主机（**程序发送的数据报是UDP数据报，其目的端口号是不可能存在的，所以，只要区分返回的ICMP报文是超时报文还是端口不可达报文，就能判断是否到达目的主机**）

### 8.3 局域网输出

![](8-1.jpg)

- 在主机svr4上traceroute到主机slip的输出：
	![](8-2.jpg)
- tcpdump监测的输出如下：			
	![](8-3.jpg)

traceroute程序注意事项：
- 不能保证UDP数据报每次的路由是一致的，如果路由发生变化，traceroute程序会打印新的IP地址
- 不能保证返回的ICMP报文和发送的UDP数据报的路由是一致的（可能导致计算出来的RTT不可靠）
- 记录的是到达路由器的那个接口IP。从A到B运行traceroute和从B到A的结果是不同的

### 8.4 广域网输出

类似局域网

### 8.5 IP源站选路选项

同样，是在IP首部内的选项

源站选路就是由发送者指定路由，有两种形式：
- 严格的源站选路（SSRR）
	- 发送端指明数据报确切的路由，若有路由器在转发时发现指定的下一站不在直连的网络上，就返回ICMP差错报文
- 宽松的源站选路（LSRR）
	- 发送端只指明一个经过的IP地址清单，其任意两个地址之间可以插入其他路由器

源站路由选项格式如图：				
	![](8-4.jpg)

运行过程如下：
	![](8-5.jpg)

源站选路traceroute程序示例：
- 宽松的源站选路
	- `traceroute -g`可为宽松的源站选路指定一些中间路由器（最多8个路由器，最后一项是目的主机）
		![](8-6.jpg)
- 严格的源站选路
	- traceroute -G`可为严格的源站选路指定一些路由器
		![](8-7.jpg)
- 利用宽松选路查看往返路由
	- traceroute至本身主机，但是指定必须经过远程的目的主机，就能看到往返的路由路径
		![](8-8.jpg)

### 习题

1. 当路由器接收到TTL为0的IP时，又打算将其减1（正常不会出现这种情况），会发生什么

	TTL会被减为255，将继续转发至下一站

2. traceroute程序和Ping程序计算RTT方法的比较

	- tracerroute程序只能在程序内存储发送数据时的时间，因为在ICMP超时差错报文内只有UDP首部，没有时间数据。只能在ICMP数据返回时在程序层面计算下大概的RTT
	- Ping程序在ICMP回显应答内存储了发送回显请求时的时间。在分组失序的情况下，Ping程序的RTT也是正确的
	- Traceroute程序等待上一个请求的应答或超时，才发送下一个请求
	- Ping程序固定每秒发送一个数据报

3. 在traceroute程序中，假设源主机和目的主机中有三个路由器（R1/R2/R3），R2收到一个TTL为1的数据报，将其减1，但错误地将其转发了，会发生什么

	- 程序的第一行输出是正确的，即R1
	- 第二行将会是R3，因为TTL为2的数据报被R2减为0并转发给了R3，由R3返回ICMP超时报文
	- 第三行也是R3，且正确

4. 条件同题3，但是是目的主机发生了错误。错误地将进入的TTL值作为返回的ICMP报文的TTL值，会发生什么

	TTL为4的UDP数据报会以TTL值1到达目的主机，且目的主机会生成ICMP端口不可达报文。但是返回的ICMP报文的TTL值为错误地为1，在返回到达R3时会被丢弃。 所以，traceroute程序不会停止，继续发送TTL为5的UDP数据报，直到发送了TTL为7的报文，才会收到目的主机返回的ICMP报文。 所以，前三行是正确的，中间三行都是超时的，最后一行标识了目的主机

5. 8.5节中，宽松的源站选路的例子中，显示出部分路由器被丢失。若在主机sun和netb之间使用`tcpdump -v`查看返回的各ICMP报文的TTL值，发现netb/butch/Gabby/enss142返回的ICMP超时报文的TTL值分别为255,253,252,249，说明什么

	- 说明路由器默认的将ICMP报文的TTL初始化为255
	- netb和butch之间有一个未察觉的路由器
	- 类似的，其他地方也能看出有一些路由器未被察觉

6. Ping程序`-l`选项（宽松源选路）和`-R`选项（记录路由）

7. Ping程序和Traceroute程序处理同一台主机上的多个实例的不同

	- Ping程序把ICMP回显请求报文的**标识符**字段设为进程ID，并包含在回显应答报文中，每个实例都需要检测此字段，只处理属于自己的那些报文
	- Traceroute程序将UDP首部的**源端口号**设为进程ID，而返回的ICMP报文中包含了UDP首部，以端口号来区分不同进程

# 9. IP选路

IP层处理的简单过程：				
	![](9-1.jpg)

### 9.2 选路的原理

