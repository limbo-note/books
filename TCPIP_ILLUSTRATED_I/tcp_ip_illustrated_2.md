# 6. ICMP Internet控制报文协议

- ICMP报文是在IP数据报内部传输的，如图：			
	![](6-1.jpg)
- ICMP报文的格式如图：					
	![](6-2.jpg)

### 6.2 ICMP报文的类型

- 不同类型的ICMP报文由类型字段和代码字段共同决定，分为查询和差错报文
- ICMP差错报文始终包含IP首部和产生ICMP差错报文的IP数据报的前8个字节
- 不会产生ICMP差错报文的情况：
	- ICMP差错报文（ICMP查询报文是可能产生差错报文的）
	- 目的地址是广播或多播地址的IP数据报
	- 链路层广播的数据报
	- 不是IP分片的第一片
	- 源地址不是单个主机的数据报（零地址、环回地址、广播多播地址）

### 6.3 ICMP地址掩码请求与应答

ICMP地址掩码请求用于**无盘系统**在引导过程中获取自己的子网掩码。与RARP类似，系统会广播ICMP地址掩码请求，收到的应答正常情况下是单播的

- ICMP地址掩码请求与应答报文格式如图：				
	![](6-3.jpg)
- 广播ICMP请求的发送主机也会发送一份拷贝到本机的环回接口，这就是广播的定义
- 向本机地址和环回地址发送地址掩码请求时，返回的地址掩码对应的都是环回地址(127.0.0.1)

### 6.4 ICMP时间戳请求与应答

向另一个系统查询当前的时间，时间精度是毫秒级别。报文格式类似地址掩码报文：
	![](6-4.jpg)

- 用途举例：
	- 用于同步主机的时间戳。可以根据请求报文RTT（往返时间）、请求报文发送时间戳和接收时间戳来确定主机间的时间差距
- 还可以通过telnet登录其它主机，运行daytime服务程序获取其它主机的时间

### 6.5 ICMP端口不可达差错

- 用tftp生成一个端口不可达报文：			
	![](6-5.jpg)
	- tcpdump查看报文的交换过程：				
		![](6-6.jpg)
	- ICMP报文是在主机之间交换（体现IP层），UDP报文是在端口之间交换

- 端口不可达报文格式如图：				
	![](6-7.jpg)
	![](6-8.jpg)
	- ICMP端口不可达报文中，UDP首部包含了原UDP报文目的端口和源端口。目的端口用于告知哪个端口不可达，源端口用于源主机由内核确定将此ICMP报文交给哪个用户进程处理（因为ICMP只在IP层，具体到用户进程需要端口信息）
	- 可观察到tftp程序在25秒后才提示传输失败，其间重传了5次UDP数据报，因为内核在收到ICMP后没有通知tftp用户进程

### 6.6 ICMP报文的BSD处理

不同系统对ICMP报文的处理是不同的，反应到的是在用户进程层面上的处理不同

###习题

1. 在可能产生ICMP差错报文的条件下，若在局域网上向不存在的端口发送一份广播的UDP数据报，会发生什么

	局域网上所有的主机都可能在同一时刻响应一个ICMP端口不可达的差错报文。这些报文的传输可能发生冲突，可能会造成网络短暂的阻塞、网络不可用

2. 生成一个ICMP端口不可达差错的级别是“必须”、“应该”还是“可能”
	
	应该

3. 略

4. `netstat -s`用于查看每个协议的统计数据


# 7. Ping程序

为了测试另一台主机是否可达。 该程序发送和接收ICMP回显请求和应答

如果Ping不同某台主机，那就不能Telnet或FTP到此主机；若不能Telnet或FTP到某主机，就可以通过Ping程序确定问题出在哪里

Ping服务器一般在内核中实现ICMP的功能

### 7.2 Ping程序

- ICMP回显请求和应答报文格式：			
	![](7-1.jpg)
- LAN（局域网）输出：				
	![](7-2.jpg)
	![](7-3.jpg)
- WAN（广域网）
	- 在广域网上的Ping程序就有可能发生丢失、重复、失序的情况
- SLIP线路
	- 略
- 拨号SLIP链路
	- 略

### 7.3 IP记录路由选项

- Ping程序的-R选项提供记录路由的功能，会在ICMP回显请求中设置IP路由选项（指的是**IP首部中的选项**）。每个处理该数据报的路由器都会把自己的IP放入选项字段中，达到目的端时，将请求中的IP清单复制到应答中，然后在返回的路径中再添加剩余的IP
	- 此方法的主要缺陷：IP首部最长60个字节，固定长度加上路由选项用去23个字节，只剩37个字节，只能存放9个IP地址，远远不足
	- IP路由记录路由器的出口IP地址

- 举例（svr4主机ping至slip主机）：						
	![](7-4.jpg)
	- 网络结构及数据报流向如图：			
		![](7-5.jpg)
	- `tcpdump -v`可查看带路由选项的输出：
		![](7-6.jpg)
- 异常的输出（slip主机ping至aix主机）：
	![](7-7.jpg)
	![](7-8.jpg)
	- 此例还将引出ICMP重定向的问题

### 7.4 IP时间戳选项

即带有时间戳的IP路由记录，只能记录4对时间戳和IP

### 习题

1. 画以上ping输出的时间线
	
	略

2. 关于SLIP链路报文计算的问题

3. 关于SLIP链路报文计算的问题2

4. 关于压缩SLIP的问题

5. 2.7节中，ping环回地址和本身主机的以太网地址会出现什么不同

	ping环回地址的RTT要比ping本身主机以太网地址的RTT要小，因为以太网驱动程序需要时间来判定这个数据报的目的地址是一个本地的主机。 但是他们的数据报都不会经过以太网（见2.7）