# 1. NIO简介

I/O往往比CPU耗时更值得优化

### 1.4 IO基本概念

- 缓冲区操作									
	![](1-1.jpg)
	- 内核试图对数据进行高速缓存或预读取，因此进程所需数据可能已经在内核空间里了。如果是这样，该数据只需简单地拷贝出来即可。如果数据不在内核空间，则**进程被挂起**，内核着手把数据读进内存
	- 内核空间作用
		- 磁盘一般是固定大小的数据块，用户进程请求的数据一般是非对齐的，则在数据往来于用户空间与存储设备的过程中，内核负责数据的分解、再组合工作
		- 硬件通常不能直接访问用户空间
	- 当用户进程需要对若干个缓冲区进行几次读操作的时候，可能内核只会进行一次系统调用，再发散给用户空间的不同缓冲区。降低消耗
- 虚拟内存
	- 不同的虚拟地址可指向同一个物理内存地址
	- 虚拟内存空间可大于实际可用的硬件内存				
	![](1-2.jpg)
- 内存页面调度
- 文件IO
	- 文件系统是更高层次的抽象，是安排、解释磁盘（或其他随机存取块设备）数据的一种方式
	- 代码都是和文件系统打交道，而不是直接和磁盘打交道
	- 分页操作系统进行IO的全过程：
		- 确定请求的数据分布在文件系统的哪些页
		- 在内核空间分配足够数量的内存页
		- 在内存页与磁盘上的文件系统页之间建立映射
		- 为每一个内存页产生页错误
		- 虚拟内存系统俘获页错误，安排页面调入，从磁盘上读取页内容，使页有效
		- 一旦页面调入操作完成，文件系统即对原始数据进行解析，取得所需文件内容或属性信息
	- 内存映射文件
	- 文件锁定 
- 流IO
	- 不像磁盘一样是面向块的，TTY（控制台）设备、打印机端口和网络连接等

# 2. 缓冲区

Buffer类图：										
	![](2-1.jpg)

### 2.1 缓冲区基础

缓冲区可看成是包在Buffer对象内的基本数据元素数组，Buffer对象提供了数组的信息和一些方便的操作

- 所有Buffer类都包含一些基本域，即在父类Buffer中定义的域：
	- 容量：能够容纳的数据元素的最大数量，在缓冲区创建时被设定，并且永远不能被改变（数组的特性）
	- 上界：缓冲区中现存元素的计数
	- 位置：下一个要被读或写的元素的索引
	- 标记：备忘位置
	- 0 <= 标记 <= 位置 <= 上界 <= 容量
- 共有的API：								
	![](2-2.jpg)  
- 存取：										
	![](2-3.jpg)
	- Java内部使用Unicode编码，占16位
- 翻转：
	- 在写好数据后，要更新“上界”域为当前的“位置”，并将“位置”置0，方便之后重头开始读取
	- 即`buffer.limit(buffer.position()).position(0)`
	- 上面的代码与`buffer.flip()`等效
	- `rewind()`与`flip()`差别只在于不更新“上界”的值
	- 两次`buffer.flip()`操作会把缓冲区“上界”变为0，相当于清空缓冲区
- 释放：
	- 

